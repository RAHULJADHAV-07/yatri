<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÜ Yatri - Smart Journey Planner</title>
    
    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3B82F6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .leaflet-container {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const API_BASE_URL = 'http://localhost:5000/api';

        // API wrapper
        const api = {
            get: async (url) => {
                const response = await fetch(`${API_BASE_URL}${url}`);
                return { data: await response.json() };
            },
            post: async (url, data) => {
                const response = await fetch(`${API_BASE_URL}${url}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return { data: await response.json() };
            }
        };

        // RouteSearch Component
        const RouteSearch = ({ onRouteSearch, stations, loading }) => {
            const [origin, setOrigin] = useState('');
            const [destination, setDestination] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!origin || !destination) {
                    alert('Please select both origin and destination');
                    return;
                }
                if (origin === destination) {
                    alert('Origin and destination cannot be the same');
                    return;
                }
                onRouteSearch(origin, destination);
            };

            const swapStations = () => {
                const temp = origin;
                setOrigin(destination);
                setDestination(temp);
            };

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h2 className="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span className="mr-2">üîç</span>
                        Plan Your Journey
                    </h2>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">From</label>
                            <select
                                value={origin}
                                onChange={(e) => setOrigin(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                required
                            >
                                <option value="">Select origin station</option>
                                {stations.map((station, index) => (
                                    <option key={index} value={station.name}>
                                        {station.name}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <div className="flex justify-center">
                            <button
                                type="button"
                                onClick={swapStations}
                                className="p-2 text-gray-500 hover:text-blue-600 transition-colors"
                                title="Swap origin and destination"
                            >
                                ‚ÜïÔ∏è
                            </button>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">To</label>
                            <select
                                value={destination}
                                onChange={(e) => setDestination(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                required
                            >
                                <option value="">Select destination station</option>
                                {stations.map((station, index) => (
                                    <option key={index} value={station.name}>
                                        {station.name}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <button
                            type="submit"
                            disabled={loading || !origin || !destination}
                            className="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-4 rounded-lg font-medium hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
                        >
                            {loading ? (
                                <div className="flex items-center justify-center">
                                    <div className="spinner mr-2"></div>
                                    Finding Routes...
                                </div>
                            ) : (
                                <div className="flex items-center justify-center">
                                    <span className="mr-2">üöÄ</span>
                                    Find Best Routes
                                </div>
                            )}
                        </button>
                    </form>

                    <div className="mt-4 pt-4 border-t border-gray-200">
                        <p className="text-xs text-gray-500 mb-2">Quick routes:</p>
                        <div className="flex flex-wrap gap-1">
                            {[
                                { from: 'Churchgate', to: 'Andheri' },
                                { from: 'CST', to: 'Thane' },
                                { from: 'Dadar', to: 'Bandra' }
                            ].map((route, index) => (
                                <button
                                    key={index}
                                    onClick={() => {
                                        setOrigin(route.from);
                                        setDestination(route.to);
                                    }}
                                    className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors"
                                >
                                    {route.from} ‚Üí {route.to}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // UserProfile Component
        const UserProfile = ({ profile, profiles, onProfileChange }) => {
            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span className="mr-2">üë§</span>
                        Travel Preference
                    </h3>
                    
                    <div className="space-y-3">
                        {Object.entries(profiles).map(([key, profileData]) => (
                            <label key={key} className="flex items-center space-x-3 cursor-pointer">
                                <input
                                    type="radio"
                                    name="profile"
                                    value={key}
                                    checked={profile === key}
                                    onChange={(e) => onProfileChange(e.target.value)}
                                    className="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"
                                />
                                <div className="flex-1">
                                    <div className="font-medium text-gray-900">{profileData.name}</div>
                                    <div className="text-sm text-gray-500">{profileData.description}</div>
                                </div>
                            </label>
                        ))}
                    </div>
                </div>
            );
        };

        // RouteResults Component
        const RouteResults = ({ routes, selectedRoute, onRouteSelect, loading, error }) => {
            if (loading) {
                return (
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <div className="flex items-center justify-center py-8">
                            <div className="spinner mr-3"></div>
                            <span className="text-gray-600">Finding best routes...</span>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <div className="text-red-600 text-center py-4">
                            <div className="text-2xl mb-2">‚ö†Ô∏è</div>
                            <div>{error}</div>
                        </div>
                    </div>
                );
            }

            if (routes.length === 0) {
                return (
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <div className="text-gray-500 text-center py-8">
                            <div className="text-4xl mb-4">üöÜ</div>
                            <div>Plan your journey to see route options</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <span className="mr-2">üõ§Ô∏è</span>
                        Route Options
                    </h3>
                    
                    <div className="space-y-3">
                        {routes.map((route, index) => (
                            <div
                                key={route.route_id || index}
                                onClick={() => onRouteSelect(route)}
                                className={`p-4 border rounded-lg cursor-pointer transition-all ${
                                    selectedRoute?.route_id === route.route_id
                                        ? 'border-blue-500 bg-blue-50'
                                        : 'border-gray-200 hover:border-gray-300'
                                }`}
                            >
                                <div className="flex justify-between items-start mb-2">
                                    <span className="font-medium text-gray-900">{route.route_type}</span>
                                    <span className="text-sm text-gray-500">‚Çπ{route.cost}</span>
                                </div>
                                
                                <div className="flex justify-between text-sm text-gray-600">
                                    <span>{route.duration} min</span>
                                    <span>{route.transfers} transfers</span>
                                </div>
                                
                                {route.eco_score && (
                                    <div className="mt-2">
                                        <span className="text-xs text-green-600">
                                            üå± Eco Score: {route.eco_score}/10
                                        </span>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // MapView Component
        const MapView = ({ routes, selectedRoute }) => {
            useEffect(() => {
                // Initialize Leaflet map
                const map = L.map('map').setView([19.0760, 72.8777], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                // Add markers for routes
                if (selectedRoute) {
                    // Add sample markers for demo
                    L.marker([19.0330, 72.8295]).addTo(map)
                        .bindPopup('Origin Station')
                        .openPopup();
                    
                    L.marker([19.1197, 72.8464]).addTo(map)
                        .bindPopup('Destination Station');
                }

                return () => {
                    map.remove();
                };
            }, [selectedRoute]);

            return <div id="map" className="w-full h-full rounded-lg"></div>;
        };

        // Main App Component
        const App = () => {
            const [routes, setRoutes] = useState([]);
            const [userProfile, setUserProfile] = useState('comfort');
            const [selectedRoute, setSelectedRoute] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [profiles, setProfiles] = useState({});
            const [stations, setStations] = useState([]);

            useEffect(() => {
                loadProfiles();
                loadStations();
            }, []);

            const loadProfiles = async () => {
                try {
                    const response = await api.get('/profiles');
                    if (response.data.success) {
                        setProfiles(response.data.profiles);
                    }
                } catch (error) {
                    console.error('Failed to load profiles:', error);
                    // Set default profiles
                    setProfiles({
                        comfort: { name: 'Comfort', description: 'Fewer transfers, AC coaches' },
                        speed: { name: 'Speed', description: 'Fastest routes' },
                        eco: { name: 'Eco-friendly', description: 'Green travel options' },
                        budget: { name: 'Budget', description: 'Cheapest options' }
                    });
                }
            };

            const loadStations = async () => {
                try {
                    const response = await api.get('/stations');
                    if (response.data.success) {
                        setStations(response.data.stations);
                    }
                } catch (error) {
                    console.error('Failed to load stations:', error);
                    // Set sample stations
                    setStations([
                        { name: 'Churchgate' },
                        { name: 'Marine Lines' },
                        { name: 'Charni Road' },
                        { name: 'Grant Road' },
                        { name: 'Mumbai Central' },
                        { name: 'Mahalaxmi' },
                        { name: 'Lower Parel' },
                        { name: 'Elphinstone Road' },
                        { name: 'Dadar' },
                        { name: 'Matunga' },
                        { name: 'Mahim' },
                        { name: 'Bandra' },
                        { name: 'Khar Road' },
                        { name: 'Santacruz' },
                        { name: 'Vile Parle' },
                        { name: 'Andheri' },
                        { name: 'CST' },
                        { name: 'Thane' }
                    ]);
                }
            };

            const handleRouteSearch = async (origin, destination) => {
                setLoading(true);
                setError(null);
                
                try {
                    const response = await api.post('/plan', {
                        origin,
                        destination,
                        profile: userProfile
                    });

                    if (response.data.success) {
                        setRoutes(response.data.routes);
                        if (response.data.routes.length > 0) {
                            setSelectedRoute(response.data.routes[0]);
                        }
                    } else {
                        setError(response.data.error || 'Failed to find routes');
                        setRoutes([]);
                    }
                } catch (error) {
                    console.error('Route search failed:', error);
                    setError('Unable to connect to server. Please try again.');
                    setRoutes([]);
                } finally {
                    setLoading(false);
                }
            };

            const handleProfileChange = (newProfile) => {
                setUserProfile(newProfile);
            };

            const handleRouteSelect = (route) => {
                setSelectedRoute(route);
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg">
                        <div className="container mx-auto px-4 py-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-3xl font-bold">üöÜ Yatri</h1>
                                    <p className="text-blue-100 mt-1">Smart Journey Planner for Mumbai</p>
                                </div>
                                <div className="hidden md:block">
                                    <div className="bg-blue-500 bg-opacity-30 rounded-lg px-4 py-2">
                                        <p className="text-sm">Fewer transfers ‚Ä¢ Smarter routes ‚Ä¢ Better experience</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <div className="container mx-auto px-4 py-6">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Left Sidebar */}
                            <div className="lg:col-span-1 space-y-6">
                                <RouteSearch 
                                    onRouteSearch={handleRouteSearch}
                                    stations={stations}
                                    loading={loading}
                                />

                                <UserProfile 
                                    profile={userProfile}
                                    profiles={profiles}
                                    onProfileChange={handleProfileChange}
                                />

                                <RouteResults 
                                    routes={routes}
                                    selectedRoute={selectedRoute}
                                    onRouteSelect={handleRouteSelect}
                                    loading={loading}
                                    error={error}
                                />
                            </div>

                            {/* Right Side - Map */}
                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                                    <div className="p-4 bg-gray-50 border-b">
                                        <h3 className="text-lg font-semibold text-gray-800">Route Visualization</h3>
                                        {selectedRoute && (
                                            <p className="text-sm text-gray-600 mt-1">
                                                Showing {selectedRoute.route_type} route ‚Ä¢ {selectedRoute.duration} min ‚Ä¢ {selectedRoute.transfers} transfers
                                            </p>
                                        )}
                                    </div>
                                    <div className="h-96 lg:h-[600px]">
                                        <MapView 
                                            routes={routes}
                                            selectedRoute={selectedRoute}
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Footer */}
                    <footer className="bg-gray-800 text-gray-300 py-8 mt-12">
                        <div className="container mx-auto px-4 text-center">
                            <p>&copy; 2024 Yatri - Built for Mumbai Hackathon</p>
                            <p className="text-sm mt-2">Making public transport smarter, one journey at a time</p>
                        </div>
                    </footer>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>